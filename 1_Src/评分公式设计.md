# 基于语义特征的分支流与异常流评分公式设计

## A	分支流 (Alternative Flow) Score 计算公式

### 语义特点分析

分支流的核心语义特点是：
1.  **最终成功 (Success Guarantee)**: 参与者的目标最终被成功实现。这说明分支流的步骤在整体上必须与用例描述的目标高度相关。
2.  **可选路径 (Alternative Path)**: 它描述的是一个“备选的”、“非主流”但同样有效的成功路径。
3.  **特定触发 (Triggered by Choice)**: 通常由一个有效的、备选的系统状态或用户选择所触发。这意味着分支流的某个步骤可能与用例描述中的某个“特定”的可选性词汇（如“或者”、“可选地”、“如果用户选择”）有极强的关联，而不是与整个描述的平均语义关联。

### 公式设计

所以这个公式的设计就是需要捕捉这种“**整体相关**”与“**局部峰值**”并存的特性：

$$
Score_{alt}(v) = \alpha \cdot \underbrace{\left(\frac{1}{|C_{Desc}|}\sum_{c \in C_{Desc}} s_{c,v}\right)}_{\text{整体相关}} + (1-\alpha) \cdot \underbrace{\left(\max_{c \in C_{Desc}} s_{c,v}\right)}_{\text{分支点相关}}
$$

其中:
* $s_{c,v} = \text{sigmoid}(h_c^L \odot h_v^L)$，与原论文定义一致。
* $\alpha \in [0, 1]$ 是一个超参数，用于平衡两种相关性的重要程度。

### 设计合理性阐述

* **平均相关性 (Average Relevance)**: 公式的左半部分 $\left(\frac{1}{|C_{Desc}|}\sum_{c \in C_{Desc}} s_{c,v}\right)$ 直接沿用了BFGen里面计算基础流节点得分的方式。它计算了候选节点 $v$ 与用例描述中所有核心词的平均相关度。这一项保证了生成的分支流步骤符合用例的**整体成功目标**（语义特点1），因为一个成功的路径必须与用例的总体意图相符。

* **峰值相关性 (Peak Relevance)**: 公式的右半部分 $\left(\max_{c \in C_{Desc}} s_{c,v}\right)$ 计算了候选节点 $v$ 与所有核心词中**最相关那一个**的得分。这个设计的灵感来源于分支流的“特定触发”和“可选路径”特性（语义特点2和3）。一个分支选项可能只在用例描述的某一处被提及（例如，“用户**也可**通过手机验证登录”），这个可选的动作（手机验证）可能与“也可”这个词有极高的相关性，但与其他描述部分（如主流程的“账号密码登录”）相关性较低。取最大值（max）操作可以有效捕捉到这种由某个“**选择点**”词汇触发的强关联信号，即使这个信号在平均计算中被稀释了。

* **超参数 $\alpha$**: 通过调整 $\alpha$，我们可以控制模型在生成分支流时的倾向性。若 $\alpha$ 较大，模型倾向于生成与整体描述更一致的、更主流的备选方案。若 $\alpha$ 较小，模型则会更倾向于捕捉由个别关键词触发的、更具“分支感”的特定路径。


## B	异常流 (Exception Flow) Score 计算公式

### 语义特点分析

异常流的核心语义特点是：
1.  **目标失败 (Goal Thwarted)**: 参与者的目标被挫败或未能实现。这意味着异常流的语义应该与用例描述所代表的“成功”语义**方向相反或存在偏离**。
2.  **处理错误 (Error Handling)**: 它描述的是如何处理一个导致目标失败的错误或异常状况。因此，异常流的动作（如“提示错误”、“终止操作”、“回滚数据”）在功能上是用于“纠错”或“中断”的。
3.  **上下文相关 (Contextually Relevant)**: 尽管是异常，但它仍然发生在当前用例的上下文中。例如，“密码错误”这个异常只与“登录”用例相关。

### 公式设计

所以异常流的得分公式就是要捕捉这种“**上下文相关**”但“**语义偏离**”的复杂特性，设计一个结合**基础相关性**与**语义偏离度**的乘积评分公式：

$$
Score_{exc}(v) = \underbrace{s_v^{(Desc.)}}_{\text{基础相关性}} \times \underbrace{\left[ \beta \cdot D_{action} + (1-\beta) \cdot D_{trigger} \right]}_{\text{加权偏离度}}
$$

其中:
* **基础相关性 (Base Relevance)**:
    $s_v^{(Desc.)} = \frac{1}{|C_{Desc}|}\sum_{c \in C_{Desc}} s_{c,v}$ ，与BFGen里面的定义一致。

* **加权偏离度 (Weighted Deviation)** 由两部分构成:
    1.  **动作偏离度 (Action Deviation)**:
        $D_{action} = 1 - \text{cos\_sim}(h_v^L, \bar{h}_C^L)$
    2.  **触发点偏离度 (Trigger Deviation)**:
        $D_{trigger} = 1 - \text{cos\_sim}(h_{c_{max}}^L, \bar{h}_C^L)$

* **符号定义**:
    * $\bar{h}_C^L = \frac{1}{|C_{Desc}|} \sum_{c \in C_{Desc}} h_c^L$ 是用例描述所有核心词Embedding的**平均向量**，可以被视为该用例“**成功场景**”的中心语义向量。
    * $h_{c_{max}}^L$ 是与候选节点 $v$ 具有最高基础相关性得分 $s_{c,v}$ 的那个核心词 $c$ 的Embedding向量。即 $c_{max} = \underset{c \in C_{Desc}}{\arg\max} \, s_{c,v}$。这个向量可以被看作是激活节点 $v$ 的“**最直接触发点**”的语义向量。
    * $\text{cos\_sim}(a, b)$ 代表向量 $a$ 和 $b$ 之间的余弦相似度。
    * $\beta \in [0, 1]$ 是一个超参数，用于平衡两种偏离度的影响。

### 设计合理性阐述

* **基础相关性 $s_v^{(Desc.)}$**: 公式的第一部分确保了候选节点 $v$ 必须与用例的**上下文相关**（语义特点3）。一个完全无关的动作（例如在“用户登录”用例中出现“播放音乐”）会因为这一项得分很低而被过滤掉。

* **加权偏离度**: 括号内的部分是整个设计的核心，它量化了候选节点 $v$ 相对于“成功”场景的偏离程度，直接对应“**目标失败**”和“**处理错误**”的语义（语义特点1和2）。
    * **动作偏离度 $D_{action}$**: 它计算了候选动作 $v$ 本身的语义（$h_v^L$）与“成功场景”中心语义（$\bar{h}_C^L$）的距离。一个典型的异常处理动作，如“terminate”（终止），其语义向量在空间上会远离“login successfully”（成功登录）这类成功语义。这个距离越大，$D_{action}$ 的值就越高，表明这个动作本身就带有“异常/中断”的属性。
    * **触发点偏离度 $D_{trigger}$**: 它计算了最可能触发动作 $v$ 的那个描述词（$h_{c_{max}}^L$）与“成功场景”中心语义（$\bar{h}_C^L$）的距离。这个设计是基于一个假设：在用例描述中，暗示异常的词汇（如“如果失败”、“无效的”）本身在语义上就偏离了主流的成功描述。如果一个动作 $v$ 主要是由这类“偏离词”触发的，那么 $D_{trigger}$ 的值就会很高，有助于模型识别由特定负面词汇引发的异常流。

* **乘法与加权结合**: 将基础相关性与加权偏离度**相乘**，意味着模型寻找的是**同时满足**“与我相关”和“但行为异常”的节点。而在偏离度内部使用**加权和**，则提供了更精细的控制，可以根据数据集的特点，来决定是更看重动作本身的异常性质（如“终止”），还是更看重触发它的描述文本的异常信号（如“无效”）。